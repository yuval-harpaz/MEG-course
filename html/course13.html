
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Random permutations for multiple comparisons</title><meta name="generator" content="MATLAB 7.11"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2013-06-03"><meta name="DC.source" content="course13.m"><style type="text/css">

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}
span.brown {color: #990000}
pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head><body><div class="content"><h1>Random permutations for multiple comparisons</h1><!--introduction--><p>Here we perform dependent sample ttest for every voxel. we have two measurements per subject, one before and one after some task (alpha1 and alpha2. We run the ttest in the end but first we compote the ttest with random run order, so for subject 1 we take alpha1 - alpha2 and for subject 2 the other way around. then we see if we still have main effect, and what size of clusters we get if we mask with a fixed threshold. We run it n times and make a distribution of the maximum t value and maximum cluster size. In the end we see if the real ttest yielded an extreme t value anywhere or whether the clusters are extremely big.</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Set N permutations and Threshold</a></li><li><a href="#2">Run the permutations</a></li><li><a href="#3">Making the real ttest </a></li><li><a href="#4">randpermute.py: prepare a template text file for for ANOVA F test</a></li><li><a href="#5">Running randpermute.py with a shell script</a></li></ul></div><h2>Set N permutations and Threshold<a name="1"></a></h2><pre class="codeinput">n=100;
tThresh=2.044;
</pre><h2>Run the permutations<a name="2"></a></h2><pre class="codeinput">clustSize=zeros(n,2);
<span class="keyword">if</span> exist(<span class="string">'tMinMax.txt'</span>,<span class="string">'file'</span>)
    <span class="syscmd">!rm tMinMax.txt</span>
<span class="keyword">end</span>
<span class="keyword">if</span> exist(<span class="string">'Post_Pre_Norm+tlrc.BRIK'</span>,<span class="string">'file'</span>)
    <span class="syscmd">!rm Post_Pre+tlrc*</span>
<span class="keyword">end</span>
<span class="keyword">if</span> exist(<span class="string">'neg+tlrc.BRIK'</span>,<span class="string">'file'</span>)
    <span class="syscmd">!rm neg+tlrc*</span>
    <span class="syscmd">!rm pos+tlrc*</span>
<span class="keyword">end</span>

<span class="syscmd">!ls quad*01 -d &gt; ls.txt</span>
LSA=importdata(<span class="string">'ls.txt'</span>);
<span class="syscmd">!rm ls</span>
<span class="keyword">for</span> permi=1:n
    <span class="keyword">if</span> exist(<span class="string">'TTnew+tlrc.BRIK'</span>,<span class="string">'file'</span>)
        <span class="syscmd">!rm TTnew+tlrc*</span>
    <span class="keyword">end</span>
    rnd1=round(rand(1,length(LSA))+1);
    rnd2=rnd1*-1+3;
    setA=<span class="string">'-setA r1 '</span>;
    setB=<span class="string">'-setB r2 '</span>;
    <span class="keyword">for</span> subi=1:length(LSA)
        setA=[setA,LSA{subi},<span class="string">'r1 '</span>,LSA{subi},<span class="string">'/alpha'</span>,num2str(rnd1(subi)),<span class="string">'+tlrc '</span>];
        setB=[setB,LSA{subi},<span class="string">'r1 '</span>,LSA{subi},<span class="string">'/alpha'</span>,num2str(rnd2(subi)),<span class="string">'+tlrc '</span>];
    <span class="keyword">end</span>
    <span class="comment">% next two lines run 3dttest++, one permutation</span>
    command = [<span class="string">'~/abin/3dttest++ -paired -no1sam -mask ~/SAM_BIU/docs/MASKbrain+tlrc '</span>,setA,setB];
    [~, ~] = unix(command);
    <span class="comment">% read min and max t value</span>
    <span class="syscmd">!~/abin/3dBrickStat -min -max TTnew+tlrc'[1]' &gt;&gt; tMinMax.txt</span>
    <span class="comment">% compute volume of largest positive and negative clusters</span>
    eval([<span class="string">'!~/abin/3dcalc -a TTnew+tlrc'''</span>,<span class="string">'[1]'''</span>,<span class="string">' -exp '''</span>,<span class="string">'ispositive(a-'</span>,num2str(tThresh),<span class="string">')*a'''</span>,<span class="string">' -prefix pos'</span>])
    eval([<span class="string">'!~/abin/3dcalc -a TTnew+tlrc'''</span>,<span class="string">'[1]'''</span>,<span class="string">' -exp '''</span>,<span class="string">'isnegative(a+'</span>,num2str(tThresh),<span class="string">')*a'''</span>,<span class="string">' -prefix neg'</span>])
    eval([<span class="string">'!~/abin/3dclust -quiet -1clip '</span>,num2str(tThresh),<span class="string">' 5 125 neg+tlrc &gt; negClust.txt'</span>])
    eval([<span class="string">'!~/abin/3dclust -quiet -1clip '</span>,num2str(tThresh),<span class="string">' 5 125 pos+tlrc &gt; posClust.txt'</span>])
    negClust=importdata(<span class="string">'negClust.txt'</span>);
    posClust=importdata(<span class="string">'posClust.txt'</span>);
    <span class="keyword">if</span> iscell(negClust)
        negClustSize=0;
    <span class="keyword">else</span>
        negClustSize=negClust(1)/125;
    <span class="keyword">end</span>
    <span class="keyword">if</span> iscell(posClust)
        posClustSize=0;
    <span class="keyword">else</span>
        posClustSize=posClust(1)/125;
    <span class="keyword">end</span>
    clustSize(permi,1:2)=[negClustSize,posClustSize];
    <span class="syscmd">!rm neg+tlrc*</span>
    <span class="syscmd">!rm pos+tlrc*</span>
    <span class="syscmd">!rm *Clust.txt</span>
<span class="keyword">end</span>
clustSize=[clustSize(:,1);clustSize(:,2)];
clustSize=sort(clustSize,<span class="string">'descend'</span>);
<span class="comment">% take the 5% greatest volumes (in voxels) as critical cluster size</span>
critClustSize=clustSize(ceil(0.05*n*2));
<span class="comment">% take the 5% extreme (max and -1*min) t values as criticat t</span>
tList=importdata(<span class="string">'tMinMax.txt'</span>);
tList=[-tList(:,1);tList(:,2)];
tList=sort(tList,<span class="string">'descend'</span>);
critT=tList(ceil(0.05*n*2));
<span class="syscmd">!rm tMinMax.txt</span>
</pre><pre class="codeoutput">rm: cannot remove `Post_Pre+tlrc*': No such file or directory
rm: cannot remove `ls': No such file or directory
++ 3dcalc: AFNI version=AFNI_2011_12_21_1014 (Mar  1 2013) [64-bit]
++ Authored by: A cast of thousands
++ Output dataset ./pos+tlrc.BRIK
++ 3dcalc: AFNI version=AFNI_2011_12_21_1014 (Mar  1 2013) [64-bit]
++ Authored by: A cast of thousands
++ Output dataset ./neg+tlrc.BRIK
.
.
.
++ Authored by: RW Cox et al
++ 3dclust: AFNI version=AFNI_2011_12_21_1014 (Mar  1 2013) [64-bit]
++ Authored by: RW Cox et al
</pre><h2>Making the real ttest<a name="3"></a></h2><pre class="codeinput">rnd1=ones(1,length(LSA));
rnd2=rnd1+1;

setA=<span class="string">'-setA r1 '</span>;
setB=<span class="string">'-setB r2 '</span>;
<span class="keyword">for</span> subi=1:length(LSA)
    setA=[setA,LSA{subi},<span class="string">'r1 '</span>,LSA{subi},<span class="string">'/alpha'</span>,num2str(rnd1(subi)),<span class="string">'+tlrc '</span>];
    setB=[setB,LSA{subi},<span class="string">'r1 '</span>,LSA{subi},<span class="string">'/alpha'</span>,num2str(rnd2(subi)),<span class="string">'+tlrc '</span>];
<span class="keyword">end</span>
<span class="comment">% making the real ttest</span>
command = [<span class="string">'~/abin/3dttest++ -paired -no1sam -prefix Post_Pre -mask ~/SAM_BIU/docs/MASKbrain+tlrc '</span>,setA,setB];
[~, ~] = unix(command);
<span class="comment">% now open AFNI and view Post_Pre+tlrc.</span>
<span class="comment">% to see if you have sig voxels check the range of the overlay (see arrow0). Note, there</span>
<span class="comment">% are two images there, means difference (brik[0]) and t values (brik[1]).</span>
<span class="comment">% choose [1] in Define Overlay (Arrow1).</span>
<span class="comment">% to see if you have large clusters set the threshold to tThresh (arrow with no number), click on</span>
<span class="comment">% clusterize (arrow2), set (arrow3), Rpt (arrow4). Look at the list for</span>
<span class="comment">% cluster size (arrow6).</span>
<span class="syscmd">!~/abin/afni -dset ~/SAM_BIU/docs/temp+tlrc</span>
</pre><pre class="codeoutput">
Thanks go to PSF Bellgowan for "quick" questions

Initializing: X11.
++++++++ IMAGE SAVE SETUP WARNINGS ++++++++
++ Can't find program mpeg_encode for Save to MPEG-1
++ Can't find program cjpeg for Save to JPEG
++ Can't find program gifsicle OR whirlgif for Save to Animated GIF
++ To disable these warnings, set environment
++  variable AFNI_IMSAVE_WARNINGS to 'NO'.
+++++++++++++++++++++++++++++++++++++++++++
. Widgets.
++ WARNING: Can't find TTatlas+tlrc or TTatlas.nii.gz dataset for 'whereami'!
++--------- See http://afni.nimh.nih.gov/pub/dist/data/
..... Input files:
 dataset count = 1
 Time series   = 0 files read
 Plugins       = 0 libraries read
 ** Your Unix path must include the AFNI binary directory
 ** OR you must setenv AFNI_PLUGINPATH to that directory!

++ WARNING: ~/.afni.log is now 23,683,342 (24 million) bytes long!
 +          (Is that you, Kevin?)

++ This version of AFNI was built Mar  1 2013 ++
++ 'Define Markers' is hidden: right-click 'DataDir' to see it

** AFNI concludes: What a long strange trip it's been!
<img vspace="5" hspace="5" src="course13_my01.png" alt="">


</pre><h2>randpermute.py: prepare a template text file for for ANOVA F test<a name="4"></a></h2>
If you don't have randpermute.py you can download it like this (linux terminal): cd abin; wget http://kurage.nimh.nih.gov/library/Meg/randpermute.py; cd;
Here we run pots of ANOVAs with random assignments to conditions. First you have to make a template text file as in the example below:
<pre class="codeinput">
<span class="keyword">################### the content of template.sh file</span>
cmd:
3dANOVA -mask ~/SAM_BIU/docs/MASKbrain+tlrc -levels 2 $permute -ftr out

output:
out+tlrc

permute:
-dset $1 quad0501/alpha1+tlrc -dset $2 quad0501/alpha2+tlrc
-dset $1 quad0601/alpha1+tlrc -dset $2 quad0601/alpha2+tlrc
-dset $1 quad0701/alpha1+tlrc -dset $2 quad0701/alpha2+tlrc
-dset $1 quad0901/alpha1+tlrc -dset $2 quad0901/alpha2+tlrc
-dset $1 quad1001/alpha1+tlrc -dset $2 quad1001/alpha2+tlrc
-dset $1 quad1201/alpha1+tlrc -dset $2 quad1201/alpha2+tlrc
-dset $1 quad1401/alpha1+tlrc -dset $2 quad1401/alpha2+tlrc
-dset $1 quad1501/alpha1+tlrc -dset $2 quad1501/alpha2+tlrc
-dset $1 quad1601/alpha1+tlrc -dset $2 quad1601/alpha2+tlrc
-dset $1 quad1801/alpha1+tlrc -dset $2 quad1801/alpha2+tlrc
-dset $1 quad2001/alpha1+tlrc -dset $2 quad2001/alpha2+tlrc
-dset $1 quad2501/alpha1+tlrc -dset $2 quad2501/alpha2+tlrc
-dset $1 quad2601/alpha1+tlrc -dset $2 quad2601/alpha2+tlrc
-dset $1 quad2701/alpha1+tlrc -dset $2 quad2701/alpha2+tlrc
-dset $1 quad2901/alpha1+tlrc -dset $2 quad2901/alpha2+tlrc
-dset $1 quad3001/alpha1+tlrc -dset $2 quad3001/alpha2+tlrc
-dset $1 quad3101/alpha1+tlrc -dset $2 quad3101/alpha2+tlrc
-dset $1 quad3601/alpha1+tlrc -dset $2 quad3601/alpha2+tlrc
-dset $1 quad3801/alpha1+tlrc -dset $2 quad3801/alpha2+tlrc
-dset $1 quad4001/alpha1+tlrc -dset $2 quad4001/alpha2+tlrc
-dset $1 quad4101/alpha1+tlrc -dset $2 quad4101/alpha2+tlrc
-dset $1 quad4201/alpha1+tlrc -dset $2 quad4201/alpha2+tlrc

values:
1
2
<span class="keyword">###################</span>
</pre><h2>Running randpermute.py with a shell script<a name="5"></a></h2>
You run the following lines in bash terminal (no matlab here).
Best to arrange the below lines in a script, say permute.sh.
Execute it from the terminal by ./permute.sh .
Dont forget to change permissions of .sh files to be executable.

<pre class="codeinput">
<span class="keyword"># run n permutations, save output in a text file called permFval</span>
randpermute.py -n 1001 -v template.sh > permFval
<span class="keyword"># get just the F values, write them to Fval file, sorted</span>
<span class="brown">grep</span> '###' permFval | <span class="brown">cut</span> -f15- -d' ' | <span class="brown">sort</span> -g -r > Fval
<span class="keyword"># get the line with the 5% greatest F</span>
old_IFS=$IFS
IFS=$'\n'
lines=($(<span class="brown">cat</span> Fval)) # array
IFS=$old_IFS
rowNum=($(<span class="brown">awk</span> 'END { print int(NR/20) }' Fval))

<span class="keyword"># clean directory</span>
<span class="brown">rm</span> permFval
<span class="brown">rm</span> *corr*
<span class="brown">rm</span> Post_Pre_F+tlrc*
<span class="keyword"># run the real F test, call it Post_Pre_F</span>
3dANOVA -mask /home/yuval/SAM_BIU/docs/MASKbrain+tlrc -levels 2 \
-dset 1 quad0501/alpha1+tlrc -dset 2 quad0501/alpha2+tlrc \
-dset 1 quad0601/alpha1+tlrc -dset 2 quad0601/alpha2+tlrc \
-dset 1 quad0701/alpha1+tlrc -dset 2 quad0701/alpha2+tlrc \
-dset 1 quad0901/alpha1+tlrc -dset 2 quad0901/alpha2+tlrc \
-dset 1 quad1001/alpha1+tlrc -dset 2 quad1001/alpha2+tlrc \
-dset 1 quad1201/alpha1+tlrc -dset 2 quad1201/alpha2+tlrc \
-dset 1 quad1401/alpha1+tlrc -dset 2 quad1401/alpha2+tlrc \
-dset 1 quad1501/alpha1+tlrc -dset 2 quad1501/alpha2+tlrc \
-dset 1 quad1601/alpha1+tlrc -dset 2 quad1601/alpha2+tlrc \
-dset 1 quad1801/alpha1+tlrc -dset 2 quad1801/alpha2+tlrc \
-dset 1 quad2001/alpha1+tlrc -dset 2 quad2001/alpha2+tlrc \
-dset 1 quad2501/alpha1+tlrc -dset 2 quad2501/alpha2+tlrc \
-dset 1 quad2601/alpha1+tlrc -dset 2 quad2601/alpha2+tlrc \
-dset 1 quad2701/alpha1+tlrc -dset 2 quad2701/alpha2+tlrc \
-dset 1 quad2901/alpha1+tlrc -dset 2 quad2901/alpha2+tlrc \
-dset 1 quad3001/alpha1+tlrc -dset 2 quad3001/alpha2+tlrc \
-dset 1 quad3101/alpha1+tlrc -dset 2 quad3101/alpha2+tlrc \
-dset 1 quad3601/alpha1+tlrc -dset 2 quad3601/alpha2+tlrc \
-dset 1 quad3801/alpha1+tlrc -dset 2 quad3801/alpha2+tlrc \
-dset 1 quad4001/alpha1+tlrc -dset 2 quad4001/alpha2+tlrc \
-dset 1 quad4101/alpha1+tlrc -dset 2 quad4101/alpha2+tlrc \
-dset 1 quad4201/alpha1+tlrc -dset 2 quad4201/alpha2+tlrc -ftr Post_Pre_F
<span class="keyword"># display result</span>
<span class="brown">echo</span>
<span class="brown">echo</span>
<span class="brown">echo</span> "########## CRITICAL F ##########"
<span class="brown">echo</span> "           F = "${lines[$rowNum]}
</pre><pre class="codeoutput">
++ 3dANOVA: AFNI version=AFNI_2011_12_21_1014 (Mar  1 2013) [64-bit]
++ Authored by: B. Douglas Ward
++ Mask from dataset '~/SAM_BIU/docs/MASKbrain+tlrc' has 11541 voxels

** Changes have been made for 3dANOVA computations.
   For details, please see:
   http://afni.nimh.nih.gov/sscc/gangc/ANOVA_Mod.html

*+ WARNING: +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
*+ WARNING: out[1] scale to shorts mean misfit error = 12.1% -- ** Take Care
 + a) Numerical precision has been lost when truncating results
       from 32-bit floating point to 16-bit integers (shorts).
 + b) Consider writing datasets out in float format.
       In most AFNI programs, use the '-float' option.
 + c) This warning is a new message, but is an old issue
       that arises when storing results in an integer format.
 + d) Don't panic! These messages likely originate in peripheral
       or unimportant voxels. They mean that you must examine your output.
       "Assess the situation and keep a calm head about you,
        because it doesn't do anybody any good to panic."
++ ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
++ Writing combined dataset into ./out+tlrc.HEAD
 + created 1 FDR curves in header
randpermute.py: #^^^^^^^^^#
randpermute.py: 3dANOVA -mask ~/SAM_BIU/docs/MASKbrain+tlrc -levels 2  -dset 2 quad0501/alpha1+tlrc -dset 1 quad0501/alpha2+tlrc -dset 1 quad0601/alpha1+tlrc -dset 2 quad0601/alpha2+tlrc -dset 1 quad0701/alpha1+tlrc -dset 2 quad0701/alpha2+tlrc -dset 2 quad0901/alpha1+tlrc -dset 1 quad0901/alpha2+tlrc -dset 1 quad1001/alpha1+tlrc -dset 2 quad1001/alpha2+tlrc -dset 1 quad1201/alpha1+tlrc -dset 2 quad1201/alpha2+tlrc -dset 2 quad1401/alpha1+tlrc -dset 1 quad1401/alpha2+tlrc -dset 2 quad1501/alpha1+tlrc -dset 1 quad1501/alpha2+tlrc -dset 1 quad1601/alpha1+tlrc -dset 2 quad1601/alpha2+tlrc -dset 1 quad1801/alpha1+tlrc -dset 2 quad1801/alpha2+tlrc -dset 2 quad2001/alpha1+tlrc -dset 1 quad2001/alpha2+tlrc -dset 2 quad2501/alpha1+tlrc -dset 1 quad2501/alpha2+tlrc -dset 2 quad2601/alpha1+tlrc -dset 1 quad2601/alpha2+tlrc -dset 2 quad2701/alpha1+tlrc -dset 1 quad2701/alpha2+tlrc -dset 2 quad2901/alpha1+tlrc -dset 1 quad2901/alpha2+tlrc -dset 1 quad3001/alpha1+tlrc -dset 2 quad3001/alpha2+tlrc -dset 1 quad3101/alpha1+tlrc -dset 2 quad3101/alpha2+tlrc -dset 2 quad3601/alpha1+tlrc -dset 1 quad3601/alpha2+tlrc -dset 2 quad3801/alpha1+tlrc -dset 1 quad3801/alpha2+tlrc -dset 1 quad4001/alpha1+tlrc -dset 2 quad4001/alpha2+tlrc -dset 2 quad4101/alpha1+tlrc -dset 1 quad4101/alpha2+tlrc -dset 2 quad4201/alpha1+tlrc -dset 1 quad4201/alpha2+tlrc -ftr out
randpermute.py: #^^^^^^^^^#
randpermute.py: Running 1001 permutations (max 4194304).
Maximum significance level will be p < 0.5
1++ 3dANOVA: AFNI version=AFNI_2011_12_21_1014 (Mar  1 2013) [64-bit]
++ Authored by: B. Douglas Ward
++ Mask from dataset '/home/yuval/SAM_BIU/docs/MASKbrain+tlrc' has 11541 voxels

** Changes have been made for 3dANOVA computations.
   For details, please see:
   http://afni.nimh.nih.gov/sscc/gangc/ANOVA_Mod.html

*+ WARNING: +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
*+ WARNING: out[1] scale to shorts mean misfit error = 11.4% -- ** Take Care
 + a) Numerical precision has been lost when truncating results
       from 32-bit floating point to 16-bit integers (shorts).
 + b) Consider writing datasets out in float format.
       In most AFNI programs, use the '-float' option.
 + c) This warning is a new message, but is an old issue
       that arises when storing results in an integer format.
 + d) Don't panic! These messages likely originate in peripheral
       or unimportant voxels. They mean that you must examine your output.
       "Assess the situation and keep a calm head about you,
        because it doesn't do anybody any good to panic."
++ ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
++ Writing combined dataset into ./out+tlrc.HEAD
 + created 1 FDR curves in header
++ 3dcalc: AFNI version=AFNI_2011_12_21_1014 (Mar  1 2013) [64-bit]
++ Authored by: A cast of thousands
++ Output dataset ./tmp+tlrc.BRIK
++ 3dbucket: AFNI version=AFNI_2011_12_21_1014 (Mar  1 2013) [64-bit]
++ 3dANOVA: AFNI version=AFNI_2011_12_21_1014 (Mar  1 2013) [64-bit]
++ Authored by: B. Douglas Ward
++ Mask from dataset '/home/yuval/SAM_BIU/docs/MASKbrain+tlrc' has 11541 voxels
Data set dimensions:  nx = 32  ny = 38  nz = 30  nxyz = 36480 

** Changes have been made for 3dANOVA computations.
   For details, please see:
   http://afni.nimh.nih.gov/sscc/gangc/ANOVA_Mod.html

*+ WARNING: +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
*+ WARNING: Post_Pre_F[1] scale to shorts mean misfit error = 12.1% -- ** Take Care
 + a) Numerical precision has been lost when truncating results
       from 32-bit floating point to 16-bit integers (shorts).
 + b) Consider writing datasets out in float format.
       In most AFNI programs, use the '-float' option.
 + c) This warning is a new message, but is an old issue
       that arises when storing results in an integer format.
 + d) Don't panic! These messages likely originate in peripheral
       or unimportant voxels. They mean that you must examine your output.
       "Assess the situation and keep a calm head about you,
        because it doesn't do anybody any good to panic."
++ ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
++ Writing combined dataset into ./Post_Pre_F+tlrc.HEAD
 + created 1 FDR curves in header


########## CRITICAL F ##########
           F = 8.34

</pre><p class="footer"><br>
      Published with MATLAB&reg; 7.11<br></p></div><!--
##### SOURCE BEGIN #####
%% Random permutations for multiple comparisons
% Here we perform dependent sample ttest for every voxel. we have two
% measurements per subject, one before and one after some task (alpha1 and
% alpha2. We run the ttest in the end but first we compote the ttest with
% random run order, so for subject 1 we take alpha1 - alpha2 and for
% subject 2 the other way around. then we see if we still have main effect,
% and what size of clusters we get if we mask with a fixed threshold. We
% run it n times and make a distribution of the maximum t value and maximum
% cluster size. In the end we see if the real ttest yielded an extreme t
% value anywhere or whether the clusters are extremely big.

%% Set N permutations and Threshold
n=100;
tThresh=2.044;

%% Run the permutations
clustSize=zeros(n,2);
if exist('tMinMax.txt','file')
    !rm tMinMax.txt
end
if exist('Post_Pre_Norm+tlrc.BRIK','file')
    !rm Post_Pre+tlrc*
end
if exist('neg+tlrc.BRIK','file')
    !rm neg+tlrc*
    !rm pos+tlrc*
end

!ls quad*01 -d > ls.txt
LSA=importdata('ls.txt');
!rm ls
for permi=1:n
    if exist('TTnew+tlrc.BRIK','file')
        !rm TTnew+tlrc*
    end
    rnd1=round(rand(1,length(LSA))+1);
    rnd2=rnd1*-1+3;
    setA='-setA r1 ';
    setB='-setB r2 ';
    for subi=1:length(LSA)
        setA=[setA,LSA{subi},'r1 ',LSA{subi},'/alpha',num2str(rnd1(subi)),'+tlrc '];
        setB=[setB,LSA{subi},'r1 ',LSA{subi},'/alpha',num2str(rnd2(subi)),'+tlrc '];
    end
    % next two lines run 3dttest++, one permutation
    command = ['~/abin/3dttest++ -paired -no1sam -mask ~/SAM_BIU/docs/MASKbrain+tlrc ',setA,setB];
    [~, ~] = unix(command);
    % read min and max t value
    !~/abin/3dBrickStat -min -max TTnew+tlrc'[1]' >> tMinMax.txt
    % compute volume of largest positive and negative clusters
    eval(['!~/abin/3dcalc -a TTnew+tlrc''','[1]''',' -exp ''','ispositive(a-',num2str(tThresh),')*a''',' -prefix pos'])
    eval(['!~/abin/3dcalc -a TTnew+tlrc''','[1]''',' -exp ''','isnegative(a+',num2str(tThresh),')*a''',' -prefix neg'])
    eval(['!~/abin/3dclust -quiet -1clip ',num2str(tThresh),' 5 125 neg+tlrc > negClust.txt'])
    eval(['!~/abin/3dclust -quiet -1clip ',num2str(tThresh),' 5 125 pos+tlrc > posClust.txt'])
    negClust=importdata('negClust.txt');
    posClust=importdata('posClust.txt');
    if iscell(negClust)
        negClustSize=0;
    else
        negClustSize=negClust(1)/125;
    end
    if iscell(posClust)
        posClustSize=0;
    else
        posClustSize=posClust(1)/125;
    end
    clustSize(permi,1:2)=[negClustSize,posClustSize];
    !rm neg+tlrc*
    !rm pos+tlrc*
    !rm *Clust.txt
end
clustSize=[clustSize(:,1);clustSize(:,2)];
clustSize=sort(clustSize,'descend');
% take the 5% greatest volumes (in voxels) as critical cluster size
critClustSize=clustSize(ceil(0.05*n*2));
% take the 5% extreme (max and -1*min) t values as criticat t
tList=importdata('tMinMax.txt');
tList=[-tList(:,1);tList(:,2)];
tList=sort(tList,'descend');
critT=tList(ceil(0.05*n*2));
!rm tMinMax.txt
%% Making the real ttest
rnd1=ones(1,length(LSA));
rnd2=rnd1+1;

setA='-setA r1 ';
setB='-setB r2 ';
for subi=1:length(LSA)
    setA=[setA,LSA{subi},'r1 ',LSA{subi},'/alpha',num2str(rnd1(subi)),'+tlrc '];
    setB=[setB,LSA{subi},'r1 ',LSA{subi},'/alpha',num2str(rnd2(subi)),'+tlrc '];
end
% making the real ttest
command = ['~/abin/3dttest++ -paired -no1sam -prefix Post_Pre -mask ~/SAM_BIU/docs/MASKbrain+tlrc ',setA,setB];
[~, ~] = unix(command);
% now open AFNI and view Post_Pre+tlrc.
% to see if you have sig voxels check the range of the overlay (see arrow0). Note, there
% are two images there, means difference (brik[0]) and t values (brik[1]).
% choose [1] in Define Overlay (Arrow1).
% to see if you have large clusters set the threshold to tThresh, click on
% clusterize (arrow2), set (arrow3), Rpt (arrow4). Look at the list for
% cluster size (arrow6).
!~/abin/afni -dset ~/SAM_BIU/docs/temp+tlrc


##### SOURCE END #####
--></body></html>
